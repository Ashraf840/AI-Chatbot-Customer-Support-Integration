<!DOCTYPE html>
{% extends 'base/chatroom_base.html' %}
{% load static %}

<!-- Title -->
{% block title %} {{ title }} | iBAS++ {% endblock %}

<!-- Custom CSS -->
{% block css %}
<!-- Fontawesome CDN -->
<script src="https://kit.fontawesome.com/272e010829.js" crossorigin="anonymous"></script>
<!-- Skeleton Loading CSS -->
<link rel="stylesheet" href="{% static 'css/home/customerSupport/skeletonLoading.css' %}">
{% endblock %}

<!-- Content Body -->
{% block content %}


{% comment %}
<h1>Customer Support Page - (Real-time Chat)</h1>
<p>Room Slug: {{ room_slug }}</p>
{% if request.user.username != '' %}
    <h4>CSO Username: {{ request.user.username }} </h4>
    {% if request.user.is_cso %}
        <div class="row">
            <div class="col">
                <p>
                    <a class="btn btn-primary btn-xl text-uppercase" href="{% url 'staffApplication:CsoWorkload:CsoDashboard' %}">CSO
                        Dashboard</a>
                </p>
            </div>
            <div class="col text-end">
                {% if not conversationInfo.is_resolved %}
                <button class="btn btn-success btn-xl text-uppercase" id="is-resolved">Is resolved</button>
                <!-- Fill up the input field with the cso dashboard-url -->
                <input type="text" id="cso-dashboard-url" value='{% url "staffApplication:CsoWorkload:SupportDashboard" request.user.email  %}' readonly disabled hidden>
                <!-- <form action="{% url 'homeApplication:CustomerSupportRoom' room_slug %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-xl text-uppercase">Is resolved</button>
                </form> -->
                {% else %}
                <button class="btn btn-secondary btn-xl text-uppercase" readonly>resolved</button>
                {% endif %}
            </div>
        </div>
    {% else %}
        <p>
            <a class="btn btn-primary btn-xl text-uppercase" href="{% url 'homeApplication:LangingPage' %}">Quit</a>
        </p>
    {% endif %}
{% else %}
    <h4> Anonymous User </h4>
    <p>
        <a class="btn btn-primary btn-xl text-uppercase" href="{% url 'homeApplication:LangingPage' %}">Quit</a>
    </p>
{% endif %}
{% endcomment %}



<!-- New UI for chatbox -->
<div class="container-fluid my-4" style="background-color: #D9D9D9;">
    <div class="row">
        <div class="col">
            <!-- User Info Row -->
            <div class="row bg-light p-2 rounded shadow">
                <div class="row">
                    <div class="col-5">
                        <!-- <ellipse cx="140" cy="125" rx="120" ry="120"
                        style="fill:yellow;stroke:purple;stroke-width:2" /> -->
                        {% if request.user.is_user %}
                            {% if cso_user_profile_pic %}
                                <img src="{{ cso_user_profile_pic.url }}" 
                                        id="user_profile_image"
                                        alt="Avatar"
                                        style="z-index: 1;
                                            width: 15rem;
                                            height: 15rem;"
                                        class="rounded mx-auto">
                            {% else %}
                                <h1>No Profile Picture</h1>
                            {% endif %}
                        {% endif %}
                        {% if request.user.is_cso %}
                            <img src="{{ registered_user_profile_pic.url }}" 
                            id="cso_profile_image"
                            alt="Avatar"
                            style="z-index: 1;
                                width: 15rem;
                                height: 15rem;"
                                class="rounded mx-auto"> 
                        {% endif %}
                    </div>
                    <div class="col">
                        <div class="row" style="margin-top: .5rem;">
                            <div class="col">
                                <!-- user-end -->
                                {% if request.user.is_user %}
                                    <h1 class="text-center">CSO Information</h1>
                                    <small><b>User Chat end</b></small>
                                    <p>{{ request.user.email }}</p>
                                    {% endif %}
                                    <!-- CSO-end -->
                                    {% if request.user.is_cso %}
                                    <h1 class="text-center">User Information</h1>
                                    <small><b>CSO Chat end</b></small>
                                    <p>{{ request.user.email }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row" style="margin-top: 2rem;">
                            {% if request.user.is_user %}
                                <div class="row"><h2>{{ cso_user_fullname }}</h2></div>
                            {% endif %}
                            {% if request.user.is_cso %}
                                <div class="row"><h3>{{ registered_user_fullname }}</h3></div>
                                {% if userName_bn != 'null' %}
                                <div class="row"><h2>{{ userName_bn }}</h2></div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
    
                {% if request.user.is_user %}
                <!-- Display CSO information -->
                <div class="row" style="margin-top: 3rem;">
                    <div class="col">
                        <div class="row my-2"><h3>Email: {{ cso_user_email }}</h3></div>
                        <div class="row my-2"><h3>Phone: {{ cso_user_phone }}</h3></div>
                    </div>
                    <div class="col-3 position-relative">
                        <button class="btn btn-lg bg-secondary position-absolute bottom-0 end-0">View Detail</button>
                    </div>
                </div>
                {% endif %}
                {% if request.user.is_cso %}
                <!-- Display user information -->
                <div class="row" style="margin-top: 1rem;">
                    <div class="col">
                        <div class="row my-2"><h3>Email: {{ registered_user_email }}</h3></div>
                        <div class="row my-2"><h3>Phone: {{ phone }}</h3></div>
                        <div class="row my-2"><h3>NID: {{ registered_user_phone }}</h3></div>
                    </div>
                    <div class="col-3 position-relative">
                        <button class="btn btn-lg bg-secondary position-absolute bottom-0 end-0">View Detail</button>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Ticket Issue -->
            <div class="row mt-4 bg-light p-2 rounded shadow">
                <div class="row position-relative">
                    <div class="row text-center mt-4 position-absolute" style="margin: 0 auto;">
                        <h2>Ticket Issue</h2>
                    </div>
                    <div class="row" style="margin-top: 5.5rem;">
                        <div class="col grid-tms-issue-skeleton">
                            <div class="row my-2"><h5>Issue ID: <div class="skeleton skeleton-text"></div></h5></div>
                            <div class="row my-2"><h5>Issue: <div class="skeleton skeleton-text"></div></h5></div>
                            <div class="row my-2"><h5>Project: <div class="skeleton skeleton-text"></div></h5></div>
                            <div class="row my-2"><h5>Issuer Mobile Number: <div class="skeleton skeleton-text"></div></h5></div>
                            <div class="row my-2"><h5>Issue Status: <div class="skeleton skeleton-text"></div></h5></div>
                        </div>

                        <div class="col grid-tms-issue-data" style="display: none">
                            <div class="row my-2"><h5>Issue ID: <div id="div_issue_id">ISSUE - 2023-2-41433</div></h5></div>
                            <div class="row my-2"><h5>Issue: <div id="div_issue">Fund Transfer</div></h5></div>
                            <div class="row my-2"><h5>Project: <div id="div_project">Smart Banking</div></h5></div>
                            <div class="row my-2"><h5>Issuer Mobile Number: <div id="div_issuer_mobile_number">+8801810176825</div></h5></div>
                            <div class="row my-2"><h5>Issue Status: <div id="div_status">Submitted</div></h5></div>
                        </div>
                        <div class="col-3 position-relative">
                            <button class="btn btn-lg bg-secondary position-absolute bottom-0 end-0">View Detail</button>
                        </div>
                    </div>
                    {% if request.user.is_cso %}
                    <div class="row mt-4" style="margin: 0 auto;">
                        <div class="col d-flex flex-row-reverse">
                            <button class="btn btn-lg bg-success mx-1">Resolved</button>
                            <button class="btn btn-lg bg-secondary mx-1">Unsolved</button>
                            <button class="btn btn-lg bg-secondary mx-1">Transferred</button>
                            <button class="btn btn-lg bg-danger mx-1">Invalid</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-7 bg-light ms-3 rounded shadow">

            <div class="row" style="height: 78.2vh;">
                {% include 'home/customerSupportComponents/chatBody.html' %}
            </div>
        </div>
    </div>
</div>










{% comment %}
<div class="row h-100 bg-primary">
    <div class="col"></div>
    <!-- Template copied from:  https://mdbootstrap.com/docs/standard/extended/chat/ -->
    <div class="col-8">
        {% include 'home/customerSupportComponents/chatBody.html' %}
    </div>
    <div class="col"></div>
</div>
{% endcomment %}

{% endblock %}



<!-- Custom JS -->
{% block js %}
<!-- Miscellaneaous JS: TMS Issue Fetch Load (Skeleton Loader) 
Ref:  https://www.youtube.com/watch?v=ZVug65gW-fc&t=55s
-->
<script>
    let grid_tms_issue_skeleton = document.querySelector('.grid-tms-issue-skeleton');
    let grid_tms_issue_data = document.querySelector('.grid-tms-issue-data');
    
    function disp(ticket_issue_oid=1, user_signin_token=2) {
        console.log(`Ticket Issue Id (from 'disp()' function): ${ticket_issue_oid}`);
        // let user_signing_token_tms = "{{ user_signing_token_tms }}";
        console.log(`User signin token (from 'disp()' function): ${user_signin_token}`);

        let span_issue_id = document.getElementById('div_issue_id');
        let span_issue = document.getElementById('div_issue');
        let span_project = document.getElementById('div_project');
        let span_issuer_mobile_number = document.getElementById('div_issuer_mobile_number');
        let span_status = document.getElementById('div_status');

        var myHeaders = new Headers();
        myHeaders.append("Accept", "application/json, text/plain, */*");
        myHeaders.append("Authorization", `Bearer ${user_signin_token}`);
        myHeaders.append("Content-Type", "application/json");
        // myHeaders.append("Referer", `https://tms-test.celloscope.net/issue/admin-issue-list/${ticket_issue_oid}`);
        // myHeaders.append("Referer", `http://172.16.6.134/issue/admin-issue-list/${ticket_issue_oid}`);
        myHeaders.append("User-Agent", "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36 OPR/96.0.0.0");
        myHeaders.append("sec-ch-ua", "\"Not=A?Brand\";v=\"8\", \"Chromium\";v=\"110\", \"Opera\";v=\"96\"");
        myHeaders.append("sec-ch-ua-mobile", "?0");
        myHeaders.append("sec-ch-ua-platform", "\"Linux\"");

        var raw = JSON.stringify({
            "oid": `${ticket_issue_oid}`
            // "oid": `64ecfb10-e036-418d-8bc0-eea566b28ca0`
            // "oid": `f6b4aca6-43b7-49ef-a491-4c4684f058ed`
        });

        var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: raw,
            redirect: 'follow'
        };

        // fetch("https://tms-test.celloscope.net/api/v1/issue-detail-by-oid", requestOptions)
        fetch("http://172.16.6.134/api/v1/issue-detail-by-oid", requestOptions)
            // .then(response => response.text())
            .then(response => response.json())
            .then(result => {
                // HIDE LOADER WILL BE IMPLEMENTED HERE
                grid_tms_issue_skeleton.style.display = "none";
                // grid_tms_issue_skeleton.remove();
                // grid_tms_issue_data.style.visibi = "block";
                grid_tms_issue_data.removeAttribute('style');

                // console.log(result);
                span_issue_id.innerHTML = "";
                span_issue_id.innerHTML = `${result.data.issue_id}`;
                span_issue.innerHTML = "";
                span_issue.innerHTML = `${result.data.category_title_en}`;
                span_project.innerHTML = "";
                span_project.innerHTML = `${result.data.project_title_en}`;
                span_status.innerHTML = "";
                span_status.innerHTML = `${result.data.status}`;
                span_issuer_mobile_number.innerHTML = "";
                span_issuer_mobile_number.innerHTML = `${result.data.issuer_mobile_number}`;
            })
            .catch(error => console.log('error', error));       // HIDE LOADER WILL BE IMPLEMENTED HERE
    }

    window.onload = function() {
        // yourFunction(param1, param2);
        console.log(`Window is fully laoded!`);
        tms_issue_oid = "{{ tms_issue_by_oid }}";
        // console.log(`TSM Issue OID: ${tms_issue_oid}`);
        let user_signing_token_tms = "{{ user_signing_token_tms }}";
        // console.log(`User signin token: ${user_signing_token_tms}`);
        disp(ticket_issue_oid=tms_issue_oid, user_signin_token=user_signing_token_tms);
    };
</script>


<!-- Miscellaneaous JS: Chat-body scroller -->
<script>
    // Scroll down the chatbody div after window loads
    var divElement = document.getElementById("chatbody-scroller");
    divElement.scroll({
        top: divElement.scrollHeight,//scroll to the bottom of the element
        behavior: 'smooth' //auto, smooth, initial, inherit
    });
</script>

<!-- WebSocket Script -->
<script>
    // VARIABLES
    const roomSlug = `{{ room_slug }}`;
    const ChatSupportURL = `ws://${window.location.host}/ws/cso-visitor/chat-support/${roomSlug}/`;    // [PRODUCTION - working]construct the websocket url
    console.log(ChatSupportURL);
    const chat_send_btn = document.querySelector('#chat-message-send-btn');
    const chat_msg_input_field = document.querySelector("#chat-message-input");
    var cso_email = `{{request.user.email}}`;


    // WEBSOCKET OBJECT
    const ChatSupportSocket = new WebSocket(ChatSupportURL);
    // console.log(ChatSupportSocket);

    // WEBSOCKET Open function
    ChatSupportSocket.onopen = function (e) {
        console.log('Frontend Websocket: Connection Established!');
    }

    // WEBSOCKET Data Receiving (from backend consumer) function
    ChatSupportSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log(data);  // comment it later
        // Chat message
        if (data.message) {
            console.log(
                (data.user_identity === 'cso')? 'message from cso': 'message from visitor'
            );

            if (data.user_identity === 'cso') {
                var chatHTML = `<div class="d-flex flex-row justify-content-start mb-4">
                            <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp"
                                alt="avatar 1" style="width: 45px; height: 100%;">
                            <div>
                                <p class="small p-2 ms-3 mb-1 rounded-3" style="background-color: #f5f6f7;">${data.message}</p>
                                <p class="small ms-3 mb-3 rounded-3 text-muted">00:07</p>
                            </div>
                        </div>`;
            } else {
                var chatHTML = `<div class="d-flex flex-row justify-content-end mb-4">
                            <div>
                                <p class="small p-2 me-3 mb-1 text-white rounded-3 bg-primary">${data.message}</p>
                                <p class="small me-3 mb-3 rounded-3 text-muted d-flex justify-content-end">00:09</p>
                            </div>
                            <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava4-bg.webp"
                                alt="avatar 1" style="width: 45px; height: 100%;">
                        </div>`;
            }
            document.querySelector('.chat-messages-box').innerHTML += chatHTML;
            // After adding the chat-message div, scroll down automatically at the bottom
            divElement.scroll({
                top: divElement.scrollHeight,//scroll to the bottom of the element
                behavior: 'smooth' //auto, smooth, initial, inherit
            });
        }
        
        // Intruder redirection
        if (data.intruder_redirection) {
            if (data.intruder_redirection === "Redirect the intruder to homepage!") {
                console.log(`Redirect the intruder to homepage!`);
                // Redirect the user to the homepage using the "ChatSupportSocket.onclose" func
                // [Ref]: https://www.w3schools.com/howto/howto_js_redirect_webpage.asp
                window.location.href = `{% url 'homeApp:LangingPage' %}`;   // works like render of dj (maybe)
                // window.location.replace(`{% url 'homeApp:LangingPage' %}`);  // works like render-redirect of dj (maybe)
            }
        }

        // Redirect the CSO & visitor accordingly to his/her CSO-dashboard & homepage, since the corresponding CSO marked the current convo as resolved.
        if (data.support_is_resolved) {
            console.log(`The support is resolved! Redirect the cso to it's dashboard & the visitor to the homepage!`);
            if (cso_email !== '') {
                console.log(`CSO email:`, cso_email);
                const cso_dashboard_url = document.querySelector("#cso-dashboard-url");
                console.log(`CSO dashboard url:`, cso_dashboard_url.value);
                window.location.href = cso_dashboard_url.value;
            } else {
                // console.log(`Visitor will be sent to the homepage!`);
                window.location.href = `{% url 'homeApp:LangingPage' %}`;
            }
        }
    }

    // WEBSOCKET Close function
    ChatSupportSocket.onclose = function (e) {
        console.log('Frontend Websocket: Connection Closed!');
    }

    // Chat Msg send btn click event
    chat_send_btn.onclick = function (e) {
        // console.log('send btn is clicked!');
        const input_field_message = chat_msg_input_field.value;
        // console.log(input_field_message);
        const user_role = `{{ request.user.is_cso }}`;
        const user_identity = (user_role === '')? 'anonymous': 'cso';
        // console.log('user identity:', user_identity)

        // check if the input field is not empty
        if (input_field_message) {
            ChatSupportSocket.send(JSON.stringify({
                'message': input_field_message,
                'user_identity': user_identity,
                'roomslug': roomSlug
            }));
            chat_msg_input_field.value = '';
        }
    }

    chat_msg_input_field.addEventListener("keypress", function (e) {
        // If the user presses the "Enter" key on the keyboard
        if (e.key === "Enter") {
            // Cancel the default action, if needed
            e.preventDefault();
            // Trigger the chat-send-button element with a click
            chat_send_btn.click();
        }
    });


    // Mark the conversation as resolved by the CSO (this js-code-block will be avaiable to the CSO-frontend)
    if (cso_email !== '') {
        const is_resolved = document.querySelector("#is-resolved");
        is_resolved.onclick = function (e) {
            var cso_email = `{{request.user.email}}`;
            console.log(`is_resolved button is clicked by the CSO; email: ${cso_email}`);
            ChatSupportSocket.send(JSON.stringify({
                'support_is_resolved': 'The support is resolved!',
                'cso_email': cso_email,
                'roomslug': roomSlug
            }));
        }
    }
</script>
{% endblock %}